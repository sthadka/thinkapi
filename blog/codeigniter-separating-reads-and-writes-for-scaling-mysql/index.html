<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="Sukumar Yethadka" />
        <meta name="copyright" content="Sukumar Yethadka" />

<meta name="keywords" content="codeigniter, replication, Codeigniter, " />
        <title>Codeigniter: Separating reads and writes for scaling MySQL - thinkAPI
</title>
        <!-- Le styles -->
        <link rel="stylesheet" type="text/css" href="../../theme/css/bootstrap.css" media="screen">
        <link rel="stylesheet" type="text/css" href="../../theme/css/bootstrap-responsive.css" media="screen">
        <link rel="stylesheet" type="text/css" href="../../theme/css/fonts.css" media="screen">
        <link rel="stylesheet" type="text/css" href="../../theme/css/code.css" media="screen">
    </head>

    <body>

        <div class="navbar">
            <div class="navbar-inner">
                <div class="container-fluid">
                    <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="brand" href="../..">thinkAPI</a>
                    <div class="nav-collapse collapse">
                        <ul class="nav pull-right">
                            <li><a href="#blog">Blog</a></li>
                            <li><a href="#projects">Projects</a></li>
                            <li><a href="#photos">Photos</a></li>
                            <li><a href="#contact">Contact</a></li>
                        </ul>
                    </div><!--/.nav-collapse -->
                </div>
            </div>
        </div>

        <div class="container-fluid">
<article>
    <div class="row-fluid">

        <div class="span9">
            <div class="row-fluid">
                <header class="page_header">
                <h1>Codeigniter: Separating reads and writes for scaling MySQL </h1>
                </header>
                <p>Generally websites average a ratio of 9:1 or more for reads:writes for their
applications which makes MySQL replication as one of the ways to scale you web
application. The simplest configuration is to separate reads and writes with
all the reads coming from the slave servers.</p>
<p><strong>MySQL Database replication</strong></p>
<p>We can implement this in <a href="http://codeigniter.com/"
target="_blank">codeigniter</a> using database groups.  Below is a sample
execution.</p>
<p>Create two active groups - one for read and one for write.</p>
<p>File: system/application/config/database.php</p>
<div class="highlight"><pre><span class="x">$active_group = &#39;write&#39;;</span>
<span class="x">$active_record = TRUE;</span>

<span class="x">$db[&#39;read&#39;][&#39;hostname&#39;] = &#39;localhost&#39;;</span>
<span class="x">$db[&#39;read&#39;][&#39;username&#39;] = &#39;root&#39;;</span>
<span class="x">$db[&#39;read&#39;][&#39;password&#39;] = &#39;&#39;;</span>
<span class="x">$db[&#39;read&#39;][&#39;database&#39;] = &#39;read_database_name&#39;;</span>
<span class="x">$db[&#39;read&#39;][&#39;dbdriver&#39;] = &#39;mysql&#39;;</span>
<span class="x">$db[&#39;read&#39;][&#39;dbprefix&#39;] = &#39;&#39;;</span>
<span class="x">$db[&#39;read&#39;][&#39;pconnect&#39;] = TRUE;</span>
<span class="x">$db[&#39;read&#39;][&#39;db_debug&#39;] = FALSE;</span>
<span class="x">$db[&#39;read&#39;][&#39;cache_on&#39;] = FALSE;</span>
<span class="x">$db[&#39;read&#39;][&#39;cachedir&#39;] = &#39;&#39;;</span>
<span class="x">$db[&#39;read&#39;][&#39;char_set&#39;] = &#39;utf8&#39;;</span>
<span class="x">$db[&#39;read&#39;][&#39;dbcollat&#39;] = &#39;utf8_general_ci&#39;;</span>

<span class="x">$db[&#39;write&#39;][&#39;hostname&#39;] = &#39;localhost&#39;;</span>
<span class="x">$db[&#39;write&#39;][&#39;username&#39;] = &#39;root&#39;;</span>
<span class="x">$db[&#39;write&#39;][&#39;password&#39;] = &#39;&#39;;</span>
<span class="x">$db[&#39;write&#39;][&#39;database&#39;] = &#39;write_database_name&#39;;</span>
<span class="x">$db[&#39;write&#39;][&#39;dbdriver&#39;] = &#39;mysql&#39;;</span>
<span class="x">$db[&#39;write&#39;][&#39;dbprefix&#39;] = &#39;&#39;;</span>
<span class="x">$db[&#39;write&#39;][&#39;pconnect&#39;] = TRUE;</span>
<span class="x">$db[&#39;write&#39;][&#39;db_debug&#39;] = FALSE;</span>
<span class="x">$db[&#39;write&#39;][&#39;cache_on&#39;] = FALSE;</span>
<span class="x">$db[&#39;write&#39;][&#39;cachedir&#39;] = &#39;&#39;;</span>
<span class="x">$db[&#39;write&#39;][&#39;char_set&#39;] = &#39;utf8&#39;;</span>
<span class="x">$db[&#39;write&#39;][&#39;dbcollat&#39;] = &#39;utf8_general_ci&#39;;</span>
</pre></div>


<p>Create separate database connections to access read and write databases
separately where needed (constructor is generally a good place for this).</p>
<div class="highlight"><pre><span class="x">$read_db = $this-&gt;load-&gt;database(&#39;read&#39;, TRUE);</span>
<span class="x">$write_db = $this-&gt;load-&gt;database(&#39;write&#39;, TRUE);</span>
</pre></div>


<p>You can now go about running queries in the usual way.</p>
<div class="highlight"><pre><span class="x">/* For reads */</span>
<span class="x">$query = $read_db-&gt;get(&#39;table_name&#39;);</span>

<span class="x">foreach ($query-&gt;result() as $row)</span>
<span class="x">{</span>
<span class="x">    echo $row-&gt;title;</span>
<span class="x">}</span>

<span class="x">/* For writes */</span>
<span class="x">$data = array(</span>
<span class="x">        &#39;title&#39; =&gt; $title,</span>
<span class="x">        &#39;name&#39; =&gt; $name,</span>
<span class="x">        &#39;date&#39; =&gt; $date</span>
<span class="x">        );</span>

<span class="x">$write_db-&gt;insert(&#39;mytable&#39;, $data);</span>
</pre></div>


<p>In case you want to try this on an application you are already running, you
can leave the &#8220;default&#8221; connection group intact and create only
the &#8220;read&#8221; connection group. Use it where you think you are
running read heavy queries.</p>
<h2>Old Comments</h2>
<p><strong>Stinky Tofu</strong></p>
<p>This is an interesting approach.  Just wondering though, if you have a master
db that is for writes only and a slave db for reads only, then instead of
asking the programmer to specify which database to read/write from/to in their
code, why not set it up so that whenever I call $db-&gt;insert,
$db-&gt;update, or $db-&gt;delete, then automatically use the master db to
perform the write, if I am calling $db-&gt;query, then the code should be
smart enough to connect to the slave db for the reads.  Would this be a safer
approach?  It would help prevent human error.  Curious to find out what you
think about this approach.</p>
<hr />
<p><strong>Sukumar Yethadka</strong></p>
<p>@Stinky Tofu
Yes, that would be quite a good approach and can be implemented
just by extending the database model.  My preference is slightly different
though. I like to use fat controllers and thin models (most of the logic is in
the controller). Because of this, I have a base model where I have all the
commonly used methods defined (different way of CRUD) and all other models
just extend from it. This way I don&#8217;t need to decide what query goes
where everyday but, just at the time of writing the model.</p>
<hr />
<p><strong>Naren</strong></p>
<p>Very interesting take. Why don&#8217;t you create a database helper/extend the
database class to abstract away the need to keep track of which DB
you&#8217;re supposed to write to, and read from.</p>
<hr />
<p><strong>Brad Proctor</strong></p>
<p>You really need to be careful with this.  What happens if you make an insert
and the user is redirected to see the results and a select is occurs of what
was just inserted, but the the master hasn&#8217;t replicated yet.  The user
sees nothing.  To fix this, that select needs to occur on the master.</p>
                <aside>
                <nav>
                <ul class="articles_timeline">
                    <li class="previous_article">Â« <a href="../../blog/how-to-skip-mysql-replication-counter/" title="Previous: How to skip MySQL replication counter">How to skip MySQL replication counter</a></li>
                </ul>
                </nav>
                </aside>
<section>
<div class="accordion" id="accordion2">
    <div class="accordion-group">
        <div class="accordion-heading">
            <a class="accordion-toggle disqus-comment-count" data-toggle="collapse" data-parent="#accordion2" 
                href="../../blog/codeigniter-separating-reads-and-writes-for-scaling-mysql//#disqus_thread">
                Comments
            </a>
        </div>
        <div id="disqus_thread" class="accordion-body collapse">
            <div class="accordion-inner">
                <div class="comments">
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'blog-notmyidea';
        var disqus_identifier = '../../blog/codeigniter-separating-reads-and-writes-for-scaling-mysql/';
    var disqus_url = '../../blog/codeigniter-separating-reads-and-writes-for-scaling-mysql/';

    (function() {
         var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
         dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
         (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
     })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>                </div>
            </div>
        </div>
    </div>
</div>
</section>
            </div>
        </div><!--/span-->

        <div class="span3">
            <div class="well sidebar-nav">
                <ul class="nav nav-list">
                    <li class="nav-header">Sukumar Yethadka</li>
                    Some dude
                    <li class="nav-header">Published</li>
                    <time pubdate="pubdate" datetime="2008-10-23T19:19:00">Oct 23, 2008</time>
                    <li class="nav-header">Category</li>
                    <a class="category-link" href="/categories.html#Codeigniter-ref">Codeigniter</a>
                    <li class="nav-header">Tags</li>
                    <ul class="list-of-tags tags-in-article">
                        <li><a href="/tags.html#codeigniter-ref">codeigniter
                            <span>2</span>
</a></li>
                        <li><a href="/tags.html#replication-ref">replication
                            <span>2</span>
</a></li>
                    </ul>
                </ul>
            </div><!--/.well -->
        </div><!--/span-->

    </div>
</article>
        </div><!--/.fluid-container-->

<div class="container-fluid">
    <footer>
    <p>&copy; thinkAPI</p>
    </footer>
</div>        <script src="http://code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/js/bootstrap.min.js"></script>

<script type="text/javascript">
    var disqus_shortname = 'blog-notmyidea';

    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
    </script>
    </body>
</html>